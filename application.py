from flask import Flask, render_template, request
from flask.ext.socketio import SocketIO, emit
import json

class LidarServer:

    data = {'data': [(0,400),
        (45,300),
        (45,300),
        (0,659),
        (1,661),
        (2,662),
        (3,664),
        (4,666),
        (5,667),
        (6,670),
        (7,672),
        (8,675),
        (9,678),
        (10,682),
        (11,685),
        (12,689),
        (13,693),
        (14,697),
        (15,702),
        (16,705),
        (17,711),
        (18,717),
        (19,723),
        (20,729),
        (21,734),
        (22,742),
        (23,750),
        (24,757),
        (25,764),
        (26,774),
        (27,782),
        (28,790),
        (29,929),
        (30,390),
        (31,147),
        (32,834),
        (33,847),
        (34,857),
        (35,871),
        (36,884),
        (37,902),
        (38,912),
        (39,929),
        (40,945),
        (41,963),
        (42,982),
        (43,1002),
        (44,1023),
        (45,1045),
        (46,1069),
        (47,1093),
        (48,1120),
        (49,1146),
        (50,1183),
        (51,1172),
        (52,1157),
        (53,1144),
        (54,1134),
        (55,1121),
        (56,1112),
        (57,1101),
        (58,1091),
        (59,1083),
        (60,1074),
        (61,1065),
        (62,1057),
        (63,1050),
        (64,1042),
        (65,1035),
        (66,1031),
        (67,1024),
        (68,1019),
        (69,1020),
        (70,0),
        (71,662),
        (72,655),
        (73,648),
        (74,655),
        (75,653),
        (76,649),
        (77,647),
        (78,645),
        (79,643),
        (80,641),
        (81,641),
        (82,640),
        (83,640),
        (84,641),
        (85,836),
        (86,0),
        (87,165),
        (88,633),
        (89,635),
        (90,765),
        (91,0),
        (92,639),
        (93,641),
        (94,643),
        (95,645),
        (96,661),
        (97,662),
        (98,666),
        (99,669),
        (100,674),
        (101,679),
        (102,683),
        (103,690),
        (104,695),
        (105,705),
        (106,702),
        (107,709),
        (108,0),
        (109,0),
        (110,923),
        (111,899),
        (112,882),
        (113,867),
        (114,852),
        (115,835),
        (116,818),
        (117,799),
        (118,782),
        (119,765),
        (120,745),
        (121,729),
        (122,714),
        (123,702),
        (124,696),
        (125,691),
        (126,688),
        (127,690),
        (128,696),
        (129,713),
        (130,0),
        (131,828),
        (132,0),
        (133,0),
        (134,0),
        (135,0),
        (136,0),
        (137,0),
        (138,0),
        (139,0),
        (140,0),
        (141,0),
        (142,0),
        (143,0),
        (144,886),
        (145,0),
        (146,0),
        (147,0),
        (148,0),
        (149,0),
        (150,0),
        (151,0),
        (152,0),
        (153,0),
        (154,934),
        (155,927),
        (156,920),
        (157,919),
        (158,917),
        (159,919),
        (160,918),
        (161,905),
        (162,5447),
        (163,179),
        (164,0),
        (165,916),
        (166,0),
        (167,133),
        (168,0),
        (169,0),
        (170,0),
        (171,0),
        (172,0),
        (173,0),
        (174,0),
        (175,0),
        (176,0),
        (177,0),
        (178,913),
        (179,909),
        (180,908),
        (181,900),
        (182,896),
        (183,891),
        (184,888),
        (185,885),
        (186,0),
        (187,915),
        (188,0),
        (189,0),
        (190,0),
        (191,0),
        (192,0),
        (193,0),
        (194,0),
        (195,0),
        (196,0),
        (197,0),
        (198,0),
        (199,0),
        (200,0),
        (201,0),
        (202,714),
        (203,712),
        (204,708),
        (205,707),
        (206,705),
        (207,703),
        (208,702),
        (209,701),
        (210,702),
        (211,700),
        (212,702),
        (213,0),
        (214,727),
        (215,0),
        (216,0),
        (217,0),
        (218,0),
        (219,0),
        (220,0),
        (221,0),
        (222,0),
        (223,0),
        (224,0),
        (225,0),
        (226,173),
        (227,38),
        (228,0),
        (229,706),
        (230,705),
        (231,701),
        (232,701),
        (233,701),
        (234,702),
        (235,702),
        (236,704),
        (237,704),
        (238,704),
        (239,706),
        (240,706),
        (241,0),
        (242,0),
        (243,186),
        (244,1712),
        (245,740),
        (246,1807),
        (247,1769),
        (248,1778),
        (249,1794),
        (250,0),
        (251,1787),
        (252,710),
        (253,764),
        (254,80),
        (255,78),
        (256,695),
        (257,693),
        (258,695),
        (259,689),
        (260,686),
        (261,683),
        (262,683),
        (263,679),
        (264,679),
        (265,680),
        (266,677),
        (267,677),
        (268,676),
        (269,676),
        (270,0),
        (271,677),
        (272,678),
        (273,679),
        (274,678),
        (275,679),
        (276,680),
        (277,683),
        (278,684),
        (279,681),
        (280,0),
        (281,596),
        (282,569),
        (283,571),
        (284,0),
        (285,0),
        (286,0),
        (287,0),
        (288,0),
        (289,0),
        (290,0),
        (291,0),
        (292,0),
        (293,0),
        (294,0),
        (295,0),
        (296,0),
        (297,0),
        (298,0),
        (299,3097),
        (300,0),
        (301,639),
        (302,0),
        (303,0),
        (304,0),
        (305,0),
        (306,0),
        (307,0),
        (308,0),
        (309,0),
        (310,0),
        (311,0),
        (312,0),
        (313,0),
        (314,0),
        (315,0),
        (316,0),
        (317,0),
        (318,0),
        (319,0),
        (320,0),
        (321,0),
        (322,0),
        (323,0),
        (324,0),
        (325,0),
        (326,0),
        (327,0),
        (328,0),
        (329,0),
        (330,0),
        (331,0),
        (332,0),
        (333,0),
        (334,0),
        (335,0),
        (336,0),
        (337,0),
        (338,0),
        (339,0),
        (340,0),
        (341,0),
        (342,0),
        (343,396),
        (344,395),
        (345,388),
        (346,386),
        (347,383),
        (348,723),
        (349,721),
        (350,720),
        (351,720),
        (352,719),
        (353,0),
        (354,721),
        (355,719),
        (356,0),
        (357,718),
        (358,719),
        (359,658)
        ]
        }

    def __init__(self):
        pass

    def publish_data(self):
        try :
            self.data = json.loads(request.form['data'])
            print "DATA: ", self.data
            return "success\n"
        except KeyError:
            print request.form
            return "Key Error: " + ",".join(request.form.keys())
        except ValueError:
            return "Value Error: " + request.form['data']

    def get_data(self):
        return self.data


application = Flask(__name__)
socketio = SocketIO(application)
lds = LidarServer()

@application.route('/')
def get_root():
    return render_template('index.html')

@application.route('/data/')
def index():
    return render_template('data.html')

# when we get a post full of data, send it!
@application.route("/publish/",  methods = ['POST'])
def publish_data():
    response = lds.publish_data()
    socketio.emit('force_update', lds.get_data())
    return response

# when we get a request for data, send it!
@socketio.on('update')
def get_data():
    d = lds.get_data()
    return d

if __name__ == '__main__':
    application.debug = True
    socketio.run(application)


